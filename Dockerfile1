# Use Nvidia CUDA base image
FROM pionai/runpod-worker-comfy-m2m:1011

WORKDIR /comfyui

# Install required models and dependencies in one RUN command to reduce layers
RUN mkdir -p custom_nodes/comfyui_controlnet_aux/ckpts/lllyasviel/Annotators \
    && wget -O custom_nodes/comfyui_controlnet_aux/ckpts/lllyasviel/Annotators/facenet.pth https://huggingface.co/lllyasviel/Annotators/resolve/main/facenet.pth \
    && wget -O custom_nodes/comfyui_controlnet_aux/ckpts/lllyasviel/Annotators/body_pose_model.pth https://huggingface.co/lllyasviel/Annotators/resolve/main/body_pose_model.pth \
    && wget -O custom_nodes/comfyui_controlnet_aux/ckpts/lllyasviel/Annotators/hand_pose_model.pth https://huggingface.co/lllyasviel/Annotators/resolve/main/hand_pose_model.pth \
    && mkdir -p models/depthanything/ \
    && wget -O models/depthanything/depth_anything_v2_vitl_fp16.safetensors https://huggingface.co/Kijai/DepthAnythingV2-safetensors/resolve/main/depth_anything_v2_vitl_fp16.safetensors \
    && wget -O models/depthanything/depth_anything_v2_vits_fp16.safetensors https://huggingface.co/Kijai/DepthAnythingV2-safetensors/resolve/main/depth_anything_v2_vits_fp16.safetensors \
    && mkdir -p models/sam2/ \
    && wget -O models/sam2/sam2_hiera_large.safetensors https://huggingface.co/Kijai/sam2-safetensors/resolve/main/sam2_hiera_large.safetensors \
    && wget -O models/controlnet/control_v11p_sd15_inpaint_fp16.safetensors https://huggingface.co/comfyanonymous/ControlNet-v1-1_fp16_safetensors/resolve/main/control_v11p_sd15_inpaint_fp16.safetensors \
    && rm -rf models/LLM/* \
    && git clone https://huggingface.co/thwri/CogFlorence-2.2-Large models/LLM/CogFlorence-2.2-Large \
    && git clone https://github.com/BadCafeCode/execution-inversion-demo-comfyui.git custom_nodes/execution-inversion-demo-comfyui \
    && rm output/* \
    && rm -rf custom_nodes/ComfyUI-SAM2 

RUN apt-get update && apt-get install -y \
    wget \
    git \
    && apt-get clean && rm -rf /var/lib/apt/lists/*


# Support for the network volume
COPY src/extra_model_paths.yaml ./

# Go back to the root
WORKDIR /

# Add ComfyUI workflow
COPY /src/workflow/ ./workflow/

# Add the start and the handler
COPY src/start.sh src/rp_handler.py test_input.json ./
RUN chmod +x /start.sh

# Start the container
CMD ["/start.sh"]
